name: Deploy 4015 Hits to Yandex Cloud

# Триггер: запускать при каждом push в ветку main
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. Логинимся в Яндекс.Реестр
      - name: Login to Yandex Container Registry
        uses: docker/login-action@v2
        with:
          registry: cr.yandex
          username: json_key
          password: ${{ secrets.YC_SA_JSON_KEY }}

      # 2. Собираем и пушим образ нашего приложения
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./app
          push: true
          # Обрати внимание на путь: cr.yandex/ID_РЕЕСТРА/имя:тег
          tags: cr.yandex/${{ secrets.YC_REGISTRY_ID }}/my-app:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          script: |
            mkdir -p ~/my_app
            cd ~/my_app

            # 1. Скачиваем конфиг (используем переменную окружения REPO)
            REPO="${{ github.repository }}"
            curl -sSL "https://raw.githubusercontent.com{REPO}/main/docker-compose.yml" -o docker-compose.yml
            
            # Проверка: если файл пустой - упасть
            [ -s docker-compose.yml ] || { echo "Файл пуст!"; exit 1; }

            # 2. Секреты
            echo "${{ secrets.ENV_FILE }}" > .env
            echo "YC_REGISTRY_ID=${{ secrets.YC_REGISTRY_ID }}" >> .env

            # 3. Логин в Яндекс (уже работает!)
            echo '${{ secrets.YC_SA_JSON_KEY }}' | docker login --username json_key --password-stdin cr.yandex

            # 4. Финал
            docker compose pull
            docker compose up -d
