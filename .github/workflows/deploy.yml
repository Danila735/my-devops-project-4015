name: Deploy 4015 Hits to Yandex Cloud

# Триггер: запускать при каждом push в ветку main
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. Логинимся в Яндекс.Реестр
      - name: Login to Yandex Container Registry
        uses: docker/login-action@v2
        with:
          registry: cr.yandex
          username: json_key
          password: ${{ secrets.YC_SA_JSON_KEY }}

      # 2. Собираем и пушим образ нашего приложения
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./app
          push: true
          # Обрати внимание на путь: cr.yandex/ID_РЕЕСТРА/имя:тег
          tags: cr.yandex/${{ secrets.YC_REGISTRY_ID }}/my-app:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          script: |
            # 1. Заходим в папку
            mkdir -p ~/my_app
            cd ~/my_app

            # 2. Скачиваем конфиг (СЛЭШ ПОСЛЕ .com ДОБАВЛЕН!)
            curl -sSL https://raw.githubusercontent.com{{ github.repository }}/main/docker-compose.yml -o docker-compose.yml
            
            # 3. Секреты (ID реестра и .env)
            echo "${{ secrets.ENV_FILE }}" > .env
            echo "YC_REGISTRY_ID=${{ secrets.YC_REGISTRY_ID }}" >> .env

            # 4. Логин в Яндекс на СЕРВЕРЕ (ОБЯЗАТЕЛЬНО!)
            echo '${{ secrets.YC_SA_JSON_KEY }}' | docker login --username json_key --password-stdin cr.yandex

            # 5. Магия: скачиваем готовый образ и запускаем
            docker compose pull
            docker compose up -d
